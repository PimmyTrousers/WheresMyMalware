package virustotal

import (
	"errors"
	"os"

	"github.com/pimmytrousers/WheresMyMalware/malsrc"
	"github.com/williballenthin/govt"
)

type Client struct {
	cli *govt.Client
}

func (c Client) QueryForSample(hash string) (bool, error) {
	// TODO: Seems to work for VT? But should check this again
	_, err := c.cli.GetFileReport(hash)
	if err != nil {
		return false, err
	}

	return true, nil
}

func (c Client) DownloadSample(hash string) ([]byte, error) {
	return nil, nil
}

func Initialize() (malsrc.MalwareService, error) {
	c := &Client{}
	key := os.Getenv("VTAPIKey")
	if len(key) == 0 {
		return nil, errors.New("no API key set for VT")
	}

	client, err := govt.New(govt.SetApikey(key), govt.SetUrl("https://www.virustotal.com/vtapi/v2/"))
	if err != nil {
		return nil, err
	}

	c.cli = client

	return c, nil
}
