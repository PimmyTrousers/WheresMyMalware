package malshare

import (
	"errors"
	"os"

	"github.com/MonaxGT/gomalshare"
	"github.com/pimmytrousers/WheresMyMalware/malsrc"
)

// Client is the malshare client to query and download samples from
type Client struct {
	cli *gomalshare.Client
}

func (c Client) QueryForSample(hash string) (bool, error) {
	res, err := c.cli.GetSearchResult(hash)
	if err != nil {
		return false, err
	}

	if len(*res) == 0 {
		return false, nil
	}

	return true, nil
}

func (c Client) DownloadSample(hash string) ([]byte, error) {
	return c.cli.DownloadFileFromHash(hash)
}

func Initialize() (malsrc.MalwareService, error) {
	c := &Client{}

	key := os.Getenv("MalshareAPIKey")
	if len(key) == 0 {
		return nil, errors.New("no API key set for Malshare")
	}

	client, err := gomalshare.New(key, "https://malshare.com/")
	if err != nil {
		return nil, err
	}

	c.cli = client

	return c, nil
}
